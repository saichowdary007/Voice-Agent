<!DOCTYPE html>
<html>
<head>
    <title>Downsampler Test</title>
</head>
<body>
    <h1>Audio Downsampler Test</h1>
    <button id="testBtn">Test Downsampler</button>
    <div id="output"></div>

    <script>
        document.getElementById('testBtn').addEventListener('click', async () => {
            const output = document.getElementById('output');
            output.innerHTML = 'Testing...';
            
            try {
                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { channelCount: 1 }
                });
                
                // Create audio context
                const audioContext = new AudioContext();
                output.innerHTML += `<br>Original sample rate: ${audioContext.sampleRate}Hz`;
                
                if (audioContext.sampleRate !== 16000) {
                    try {
                        // Load downsampler
                        await audioContext.audioWorklet.addModule('/downsampler.js');
                        
                        // Create downsampler
                        const source = audioContext.createMediaStreamSource(stream);
                        const downsampler = new AudioWorkletNode(audioContext, 'downsampler', {
                            processorOptions: { targetSampleRate: 16000 }
                        });
                        
                        // Create destination
                        const dest = audioContext.createMediaStreamDestination();
                        
                        // Connect
                        source.connect(downsampler);
                        downsampler.connect(dest);
                        
                        output.innerHTML += '<br>‚úÖ Downsampler initialized successfully';
                        
                        // Test MediaRecorder with downsampled stream
                        const recorder = new MediaRecorder(dest.stream, {
                            mimeType: 'audio/webm;codecs=opus',
                            audioBitsPerSecond: 64000
                        });
                        
                        recorder.ondataavailable = (event) => {
                            output.innerHTML += `<br>üì¶ Recorded chunk: ${event.data.size} bytes`;
                        };
                        
                        recorder.start(250);
                        output.innerHTML += '<br>üéôÔ∏è Recording started (speak now)...';
                        
                        setTimeout(() => {
                            recorder.stop();
                            output.innerHTML += '<br>‚èπÔ∏è Recording stopped';
                            stream.getTracks().forEach(track => track.stop());
                        }, 3000);
                        
                    } catch (error) {
                        output.innerHTML += `<br>‚ùå Downsampler error: ${error.message}`;
                    }
                } else {
                    output.innerHTML += '<br>‚ÑπÔ∏è Already at 16kHz, no downsampling needed';
                }
                
            } catch (error) {
                output.innerHTML += `<br>‚ùå Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>